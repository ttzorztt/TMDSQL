# TMDSQL
## 总体设计思路
- 无界面全终端操作方式,前端具有shell解析。并直接运行TMDSQL语句。
- 自定义中文TMDSQL语言,并实现该语言的语法检查,语义检查,转化为底层的C++代码并操作数据库。
- 创建数据库和数据库表,增删改查更新基本操作。
- 多用戶登录,读写上锁,视图层实现。
- 使用双级缓存进行数据读取。使得读取速度加快。
- 主键采取聚簇索引的底层形式。并采取缓冲形式进行查询速度的优化。
## 总体思路
> 对数据库的数据，我采取目录对应数据库，文件对应表的方式。除了数据库目录和表文件以外，我仿照Linux对于锁的建立，用'.'开头的隐藏文件同名文件建立锁，对于文件的读取，我采取字符型存取，大量数据的文件读取速度如果仅仅采取按行存取则会很慢，那么我借助文件指针的思想，建立索引文件，用来保存索引字段与文件指针的对于关系，以便于后期直接根据文件指针的位置随机存取。而索引文件本身很大，借助操作系统中的段页式文件，于是我建立二级索引文件以加快查询。而索引文件本身是有序的，采取二分折半查找的方式查询。

## 运行须知
- 本项目采用UTF-8的编码方式，而在UTF-8的编码方式中，一个汉字是三个字节。而项目编写时采取的环境是`gcc version 10.2.1 20210110 (Debian 10.2.1-6)`,linux中默认采取UTF-8的编码方式，如果采取windows系统，可能需要进行一些设置或者在编译的时候加上一些参数来将其设置为UTF-8.
## src目录及其主要功能介绍
### `dir.h && dir.cpp`
  > 主要实现目录操作，在内核中，目录对应于数据库，封装_dir类。
### `file.h && file.cpp`
  > 封装文件操作类_file,在内核中，文件对应表。
### `DataBase.h && DataBase.cpp` 
  > 保护继承_dir类，调用一些_file的静态函数以辅助实现对数据库本身的操作
### `table.h && table.cpp`
  > 保护继承_file类，封装一些对表本身的操作 
### `shell.h && shell.cpp`
  > 对中文TMDsql语句的封装
### `super.h && super.cpp`
  > 对所有公有函数，枚举量以及全局静态const常量的声明与定义。
### `Index.h && Index.cpp`
  > 封装对表索引操作的声明与定义
### `TablePCB.h && TablePCB.cpp`
  > 封装对表PCB操作的声明与定义
### `DataBase.h && DataBase.cpp`
  > 封装对数据库PCB操作的声明和定义
## data目录的结构
### database
  > 数据库存放路径，其子文件夹为各个数据库文件夹，文件夹名即为数据库名，而该文件夹内，为表名，不含后缀，可以拿记事本以UTF-8的编码方式打开，内置数据存放方式是以CSV方式存放。
### index
  > 索引文件存储路径，其子文件夹为各个数据库文件夹，而在数据库文件夹中，并非存放表，而存放表的索引文件，命名方式与表名相同。
### PCB
  > PCB文件存储路径，其子文件夹为各个数据库文件夹，而在数据库文件夹中，存放表PCB文件。命名方式与表名相同。
### log
  > 日志文件存储路径，其内容为总日志记录
## 数据文件存储方式
![tree](ohter/svg/dataTree.svg)
## tablePCB的内容
1. name
2. nextIndex
  > 下一行的起始文件指针
3. length
  > 行数

# shell语言解释器
## 字段解释
### ID
`ID` 是该指令的一个编号
### OP
`OP` 为权限值，分为四种权限
- `OP`=0 为Root权限 
- `OP`=1 为管理员权限
- `OP`=2 为普通用户权限
- `OP`=3 为未登录权限
> 权限显而易见是ROOT > 管理员权限 > 普通用户权限,而不同权限，可以做不同的操作，简单来说，普通用户只有查询和一些查看内容的操作，一切对于数据库的修改，比如数据库的创建，数据库的删除，表的创建，表的删除等必须具有管理员或超越管理员的权限，同时管理员具有添加普通用户的权限。而ROOT作为超级管理员，可以添加管理员帐号。
### CID
`CID`是每个关键字的编号
## 用户提示符
### 未登录
  >(未登录) -=> 
### 普通用户
  >(用户) -=> 
### 管理员
  >(管理员) -=> 
### 超级管理员
  >(超级管理员) -=> 
## 支持语句
  > 总体来说，TMDSQL支持中文，且关键字之间用`空格`隔开，结尾没有封号，每条指令必读独立占据一行。
### PWD
- pwd = `[]`,默认状态，说明当前未选择数据库，且未登录。此种状态不可以执行除去<font color="red">登录</font>外的任何指令,均会输出: <br>
>(未登录) -=> 未登录,请登录后操作! 
- pwd = ["/"],说明当前已经登录，并未知帐号信息，且没有选择数据库
- pwd = ["/"]["测试数据库1"]， 说明当前已经登录，且已经选择一个名叫测试数据库的数据库。
- pwd = ["/"]["测试数据库1"]["测试表1"]， 说明当前已经登录，且当前已经选择测试数据库1下的测试表1

- **以下对于指令介绍，由于未知用户权限，将未知用户的用户提示符改为`(?) -=>`**
- **红色字体为关键字，蓝色字体为用户输入随意字符串,需要使用@开头，后面的则不需要**
### `选择`
- 使用 `选择`指令，首先判断是否登录，如果没有登录，无法操作，登录后根据登录帐号的权限，使用该指令会让当前shell的pwd改变，但是需要先选择数据库，然后选择表.
- <font color="red">选择</font> <font color="red">数据库</font> <font style=color:blue>@测试数据库1</font> <br> 
    pwd.size() > 0，不管当前pwd到达那一步，都可以直接修改pwd
- <font color="red">选择</font> <font color="red">表</font> <font color="blue">@测试表1</font>
  - pwd.size() == 1,表示当前没有选择数据库，则无法选择，提示: <br>
      > (?) -= > 无法执行该指令，请先选择数据库!
  - pwd.size() == 2 表示已经选择数据库<br>
    - 已经选择的数据库中有没有<font color="blue">测试表1</font>,提示: <br>



- <font color="red">选择</font> <font color="red">数据库</font> <font color="red">表</font> <font color="blue">@测试表1</font>
### `显示`
- <font color="red">显示</font>
  - 使用`显示`指令，根据当前的pwd分为四种情况：
    - pwd = `[]`,使用该指令后，无法执行除去登录以外的任何操作。
    >(未登录) -=> 未登录,请登录后操作!
    - pwd = ["/"]
    >(?) -= > 当前路径为:/
    - pwd = ["/"]["测试数据库1"]
    >(?) -= > 当前路径为:/测试数据库1
    - pwd = ["/"]["测试数据库1"]["测试表1"]
    >(?) -= > 当前路径为:/测试数据库1/测试表1
- <font color="red">显示</font> <font color="red">数据库</font> <br>
该指令需要`pwd.size() > 1`,也就是说pwd中必须已经选择到数据库，可以选择到表，最起码当前已经指定数据库。